<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grocery Store - Orders</title>
    <link rel="icon" type="image/png" href="/images/logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        body {
          background-color: #f8f9fa;
          padding: 20px;
        }
        .card {
          border-radius: 12px;
        }
        .table-container {
          overflow-x: auto;
        }
        .status-badge {
          font-size: 0.75rem;
          padding: 0.35em 0.65em;
          border-radius: 6px;
        }
        .action-buttons {
          display: flex;
          gap: 0.25rem;
          flex-wrap: nowrap;
        }
        .action-buttons .btn {
          padding: 0.25rem 0.5rem;
          font-size: 0.75rem;
          line-height: 1.2;
        }
        .status-PENDING {
          background-color: #ffc107;
          color: #000;
        }
        .status-CONFIRMED {
          background-color: #0d6efd;
          color: #fff;
        }
        .status-SHIPPED {
          background-color: #6f42c1;
          color: #fff;
        }
        .status-DELIVERED {
          background-color: #198754;
          color: #fff;
        }
        .status-CANCELLED {
          background-color: #dc3545;
          color: #fff;
        }
    </style>
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-success">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">Grocery Store Admin</a>
        <div>
            <a href="/store.html" class="btn btn-outline-light me-2">
                <i class="bi bi-shop"></i> Back to Store
            </a>
            <a href="/admin/" class="btn btn-outline-light">
                <i class="bi bi-speedometer2"></i> Dashboard
            </a>
        </div>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 d-md-block sidebar collapse">
            <div class="d-flex flex-column flex-shrink-0 p-3">
                <ul class="nav nav-pills flex-column mb-auto">
                    <li class="nav-item">
                        <a href="/admin/" class="nav-link">
                            <i class="bi bi-speedometer2 me-2"></i>
                            Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/admin/products.html" class="nav-link">
                            <i class="bi bi-box-seam me-2"></i>
                            Products
                        </a>
                    </li>
                    <li>
                        <a href="/admin/orders.html" class="nav-link active">
                            <i class="bi bi-cart3 me-2"></i>
                            Orders
                        </a>
                    </li>
                    <li>
                        <a href="/admin/users.html" class="nav-link">
                            <i class="bi bi-people me-2"></i>
                            Users
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Main content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Orders</h1>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>Order Management</h2>
                    <p class="text-muted mb-0">Monitor customer orders and their fulfillment status.</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="/store.html" class="btn btn-outline-secondary">
                        <i class="bi bi-shop"></i> Back to Store
                    </a>
                </div>
            </div>

<div class="card p-4 mb-4 shadow-sm">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
        <h4 class="mb-0">Order History</h4>
        <div class="search-container" style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px;">
            <input
                    type="text"
                    id="searchInput"
                    placeholder="Search by name or phone..."
                    onkeypress="if(event.key === 'Enter') loadOrders(0)"
                    style="flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 6px;"
            />

            <button
                    onclick="loadOrders(0)"
                    class="btn btn-primary"
                    style="padding: 10px 18px; border-radius: 6px;">
                <i class="bi bi-search"></i> Search
            </button>

            <button
                    onclick="clearSearch()"
                    class="btn btn-secondary"
                    style="padding: 10px 18px; border-radius: 6px;">
                <i class="bi bi-x"></i> Clear
            </button>

            <div class="d-flex align-items-center" style="white-space: nowrap; margin-left: 10px;">
                <label for="itemsPerPage" class="me-2 mb-0">Items per page:</label>
                <select id="itemsPerPage" onchange="loadOrders(0)" class="form-select form-select-sm" style="width: auto;">
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                </select>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="table-light">
            <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Phone</th>
                <th>Address</th>
                <th>Payment</th>
                <th>Status</th>
                <th>Order Time</th>
                <th>Total</th>
                <th>Items</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="orders-table-body"></tbody>
        </table>
    </div>

    <!-- Edit Order Modal -->
    <div class="modal fade" id="editOrderModal" tabindex="-1" aria-labelledby="editOrderModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editOrderModalLabel">Edit Order #<span id="editOrderId"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editOrderForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="editCustomerName" class="form-label">Customer Name</label>
                                <input type="text" class="form-control" id="editCustomerName" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editPhoneNumber" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="editPhoneNumber" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editAddress" class="form-label">Delivery Address</label>
                            <textarea class="form-control" id="editAddress" rows="2" required></textarea>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="editPaymentMethod" class="form-label">Payment Method</label>
                                <select class="form-select" id="editPaymentMethod" required>
                                    <option value="CASH">Cash on Delivery</option>
                                    <option value="CARD">Credit/Debit Card</option>
                                    <option value="ONLINE">Online Payment</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="editStatus" class="form-label">Status</label>
                                <select class="form-select" id="editStatus" required>
                                    <option value="PENDING">Pending</option>
                                    <option value="CONFIRMED">Confirmed</option>
                                    <option value="SHIPPED">Shipped</option>
                                    <option value="DELIVERED">Delivered</option>
                                    <option value="CANCELLED">Cancelled</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="editNotes" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">Order Items</h6>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="addItemBtn">
                                    <i class="bi bi-plus"></i> Add Item
                                </button>
                            </div>
                            <div id="orderItemsList" class="border p-2 rounded">
                                <!-- Order items will be populated here -->
                            </div>
                            <div class="text-end mt-2">
                                <strong>Total: $<span id="orderTotal">0.00</span></strong>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveOrderChanges">Save changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    <nav>
        <ul class="pagination mt-3" id="pagination"></ul>
    </nav>
                </div>
            </main>
        </div>
    </div>
</div>

<script>
    const API_URL = "/api/v1/orders";
    let currentPage = 0;
    let itemsPerPage = 10;
    let totalPages = 0;
    let currentEditingOrderId = null;
    
    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
        // Get page number from URL or default to 0 (first page)
        const urlParams = new URLSearchParams(window.location.search);
        const pageFromUrl = parseInt(urlParams.get('page')) || 0;
        
        // Initialize event listeners
        const itemsPerPageEl = document.getElementById("itemsPerPage");
        const searchBtn = document.getElementById("searchBtn");
        const clearSearchBtn = document.getElementById("clearSearchBtn");
        const saveChangesBtn = document.getElementById('saveOrderChanges');
        
        if (itemsPerPageEl) {
            itemsPerPageEl.addEventListener("change", function () {
                itemsPerPage = parseInt(this.value);
                loadOrders(0);
            });
        }
        
        if (searchBtn) {
            searchBtn.addEventListener("click", () => loadOrders(0));
        }
        
        if (clearSearchBtn) {
            clearSearchBtn.addEventListener("click", () => {
                document.getElementById("searchInput").value = "";
                loadOrders(0);
            });
        }
        
        if (saveChangesBtn) {
            saveChangesBtn.addEventListener('click', saveOrderChanges);
        }
        
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Load initial orders
        loadOrders(Math.max(0, pageFromUrl - 1)); // Convert to 0-based index
    });
    
    // Save order changes function
    async function saveOrderChanges() {
        if (!currentEditingOrderId) {
            showAlert('No order selected for update', 'warning');
            return;
        }
        
        const saveButton = document.getElementById('saveOrderChanges');
        const originalButtonText = saveButton.innerHTML;
        
        try {
            // Show loading state
            saveButton.disabled = true;
            saveButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
            
            // Prepare order data with all necessary fields
            const orderData = {
                customerName: document.getElementById('editCustomerName').value,
                phoneNumber: document.getElementById('editPhoneNumber').value,
                address: document.getElementById('editAddress').value,
                paymentMethod: document.getElementById('editPaymentMethod').value,
                status: document.getElementById('editStatus').value,
                notes: document.getElementById('editNotes').value || null,
                items: currentOrderItems.map(item => ({
                    id: item.id, // Include the item ID for updates
                    productId: item.productId,
                    productName: item.productName, // Include product name
                    quantity: item.quantity,
                    unitPrice: item.unitPrice,
                    lineTotal: item.unitPrice * item.quantity
                }))
            };
            
            console.log('Sending update with data:', JSON.stringify(orderData, null, 2));
            
            // Validate order items
            if (orderData.items.length === 0) {
                throw new Error('Order must have at least one item');
            }
            
            // Check for insufficient stock with detailed error message
            // Only validate if we're increasing quantities beyond available stock
            const stockIssues = [];
            
            // Get the original order to compare quantities
            try {
                const originalResponse = await fetch(`${API_URL}/${currentEditingOrderId}`);
                if (originalResponse.ok) {
                    const originalOrder = await originalResponse.json();
                    
                    // Create a map of original quantities for comparison
                    const originalQuantities = {};
                    (originalOrder.items || []).forEach(item => {
                        originalQuantities[item.productId] = item.quantity;
                    });
                    
                    // Check each item in the current order
                    currentOrderItems.forEach(item => {
                        const originalQty = originalQuantities[item.productId] || 0;
                        const quantityChange = item.quantity - originalQty;
                        
                        // Only show error if increasing quantity beyond available stock
                        if (quantityChange > 0 && item.availableStock !== undefined && 
                            item.quantity > item.availableStock) {
                            stockIssues.push(
                                `${item.productName} (Available: ${item.availableStock}, ` +
                                `Current: ${originalQty}, Requested: +${quantityChange})`
                            );
                        }
                    });
                }
            } catch (e) {
                console.error('Error fetching original order:', e);
                // If we can't get the original order, fall back to basic validation
                currentOrderItems.forEach(item => {
                    if (item.availableStock !== undefined && item.quantity > item.availableStock) {
                        stockIssues.push(
                            `${item.productName} (Available: ${item.availableStock}, ` +
                            `Requested: ${item.quantity})`
                        );
                    }
                });
            }
            
            if (stockIssues.length > 0) {
                throw new Error(`Cannot update order due to insufficient stock for:\n${stockIssues.join('\n')}`);
            }
            
            // Send the update request
            const response = await fetch(`${API_URL}/${currentEditingOrderId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(orderData)
            });
            
            if (!response.ok) {
                let errorMessage = 'Failed to update order';
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.message || errorMessage;
                } catch (e) {
                    // If we can't parse the error as JSON, use the status text
                    errorMessage = response.statusText || errorMessage;
                }
                throw new Error(errorMessage);
            }
            
            // Close the modal first to prevent further interactions
            const modal = bootstrap.Modal.getInstance(document.getElementById('editOrderModal'));
            if (modal) {
                modal.hide();
            }
            
            // Show success message
            showAlert('Order updated successfully', 'success');
            
            // Force a complete refresh of the page to ensure all data is in sync
            // This is a temporary measure to ensure consistency
            setTimeout(() => {
                window.location.reload();
            }, 1000);
            
        } catch (error) {
            console.error('Error updating order:', error);
            showAlert(error.message || 'Failed to update order. Please try again.', 'danger');
        } finally {
            // Reset button state
            saveButton.disabled = false;
            saveButton.innerHTML = originalButtonText;
        }
    }

    async function loadOrders(page) {
      try {
        const search = document.getElementById("searchInput").value;
        currentPage = page;
        
        let url = `${API_URL}?page=${page}&size=${itemsPerPage}`;
        if (search) {
          url += `&search=${encodeURIComponent(search)}`;
        }
        
        // Show loading state
        document.getElementById("orders-table-body").innerHTML = `
          <tr>
            <td colspan="9" class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </td>
          </tr>`;
        
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Handle empty results
        if (!data.orders || data.orders.length === 0) {
          renderOrders([]);
          renderPagination(0);
          return;
        }
        
        renderOrders(data.orders);
        renderPagination(data.totalPages || 1);
        
        // Update URL without page reload
        const params = new URLSearchParams(window.location.search);
        params.set('page', page + 1);
        params.set('size', itemsPerPage);
        if (search) params.set('search', search);
        
        const newUrl = `${window.location.pathname}?${params.toString()}`;
        window.history.pushState({}, '', newUrl);
        
      } catch (error) {
        console.error('Error loading orders:', error);
        document.getElementById("orders-table-body").innerHTML = `
          <tr>
            <td colspan="9" class="text-center text-danger py-4">
              Error loading orders. Please try again.
            </td>
          </tr>`;
      }
    }

    function renderOrders(orders) {
      const tbody = document.getElementById("orders-table-body");
      tbody.innerHTML = "";

      if (!orders || orders.length === 0) {
        tbody.innerHTML = `<tr><td colspan="9" class="text-center text-muted">No orders found.</td></tr>`;
        return;
      }

      orders.forEach(order => {
        const itemsText = order.items
          .map(i => `${i.quantity} Ã— ${i.productName}`)
          .join("<br>");

        tbody.innerHTML += `
          <tr>
            <td>${order.id}</td>
            <td>${order.customerName}</td>
            <td>${order.phoneNumber}</td>
            <td>${order.address}</td>
            <td>${order.paymentMethod}</td>
            <td>${order.status}</td>
            <td>${new Date(order.orderTime).toLocaleString()}</td>
            <td>$${order.totalAmount.toFixed(2)}</td>
            <td>${itemsText}</td>
            <td>
              <div class="action-buttons">
                <button class="btn btn-sm btn-outline-primary" onclick="viewOrder(${order.id})" title="View Order">
                  <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-warning" onclick="editOrder(${order.id})" title="Edit Order">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete(${order.id})" title="Delete Order">
                  <i class="bi bi-trash"></i>
                </button>
                <div class="dropdown d-inline-block">
                  <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="statusDropdown${order.id}" data-bs-toggle="dropdown" aria-expanded="false" title="Change Status">
                    <i class="bi bi-arrow-repeat"></i>
                  </button>
                  <ul class="dropdown-menu" aria-labelledby="statusDropdown${order.id}">
                    <li><a class="dropdown-item ${order.status === 'PENDING' ? 'active' : ''}" href="#" onclick="updateStatus(${order.id}, 'PENDING')">
                      <i class="bi bi-hourglass me-2"></i>Mark as Pending
                    </a></li>
                    <li><a class="dropdown-item ${order.status === 'CONFIRMED' ? 'active' : ''}" href="#" onclick="updateStatus(${order.id}, 'CONFIRMED')">
                      <i class="bi bi-check-circle me-2"></i>Confirm Order
                    </a></li>
                    <li><a class="dropdown-item ${order.status === 'SHIPPED' ? 'active' : ''}" href="#" onclick="updateStatus(${order.id}, 'SHIPPED')">
                      <i class="bi bi-truck me-2"></i>Mark as Shipped
                    </a></li>
                    <li><a class="dropdown-item ${order.status === 'DELIVERED' ? 'active' : ''}" href="#" onclick="updateStatus(${order.id}, 'DELIVERED')">
                      <i class="bi bi-check-circle-fill me-2"></i>Mark as Delivered
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger ${order.status === 'CANCELLED' ? 'active' : ''}" href="#" onclick="updateStatus(${order.id}, 'CANCELLED')">
                      <i class="bi bi-x-circle me-2"></i>Cancel Order
                    </a></li>
                  </ul>
                </div>
              </div>
            </td>
          </tr>`;
      });
    }

    function renderPagination(pages) {
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";
      totalPages = pages;
      
      // Previous button
      pagination.innerHTML += `
        <li class="page-item ${currentPage === 0 ? 'disabled' : ''}">
          <button class="page-link" onclick="loadOrders(${currentPage - 1})" ${currentPage === 0 ? 'disabled' : ''}>
            &laquo;
          </button>
        </li>`;
      
      // Page numbers
      const maxVisiblePages = 5;
      let startPage = Math.max(0, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages - 1, startPage + maxVisiblePages - 1);
      
      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(0, endPage - maxVisiblePages + 1);
      }
      
      for (let i = startPage; i <= endPage; i++) {
        pagination.innerHTML += `
          <li class="page-item ${i === currentPage ? 'active' : ''}">
            <button class="page-link" onclick="loadOrders(${i})">${i + 1}</button>
          </li>`;
      }
      
      // Next button
      pagination.innerHTML += `
        <li class="page-item ${currentPage >= totalPages - 1 ? 'disabled' : ''}">
          <button class="page-link" onclick="loadOrders(${currentPage + 1})" ${currentPage >= totalPages - 1 ? 'disabled' : ''}>
            &raquo;
          </button>
        </li>`;
    }

    // Event listener for search input enter key
    document.getElementById("searchInput")?.addEventListener("keypress", function(e) {
        if (e.key === 'Enter') {
            loadOrders(0);
        }
    });

    // Action functions
    async function viewOrder(orderId) {
        try {
            currentEditingOrderId = orderId;
            const response = await fetch(`${API_URL}/${orderId}`);
            if (!response.ok) throw new Error('Failed to fetch order details');
            
            const order = await response.json();
            const modalElement = document.getElementById('editOrderModal');
            
            if (!modalElement) {
                throw new Error('Edit order modal not found');
            }
            
            // Set modal title
            const modalTitle = modalElement.querySelector('.modal-title');
            if (modalTitle) {
                modalTitle.textContent = `View Order #${order.id}`;
            }
            
            // Hide save button
            const saveButton = document.getElementById('saveOrderChanges');
            if (saveButton) {
                saveButton.style.display = 'none';
            }
            
            // Make all form controls read-only
            const formControls = modalElement.querySelectorAll('input, select, textarea');
            formControls.forEach(control => {
                control.setAttribute('readonly', true);
                control.classList.add('bg-light');
            });
            
            // Hide action buttons in order items
            modalElement.querySelectorAll('.btn-quantity, .btn-remove-item, #addItemBtn').forEach(btn => {
                btn.style.display = 'none';
            });
            
            // Populate the modal with order data
            const setValueIfExists = (id, value) => {
                const element = document.getElementById(id);
                if (element) element.value = value || '';
            };
            
            const orderIdElement = document.getElementById('editOrderId');
            if (orderIdElement) orderIdElement.textContent = order.id || '';
            
            setValueIfExists('editCustomerName', order.customerName);
            setValueIfExists('editPhoneNumber', order.phoneNumber);
            setValueIfExists('editAddress', order.address);
            setValueIfExists('editPaymentMethod', order.paymentMethod);
            setValueIfExists('editStatus', order.status);
            setValueIfExists('editNotes', order.notes);
            
            // Disable the status dropdown
            const statusSelect = document.getElementById('editStatus');
            if (statusSelect) statusSelect.disabled = true;
            
            // Show the modal
            const modal = new bootstrap.Modal(modalElement);
            
            // Reset modal state when hidden
            modalElement.addEventListener('hidden.bs.modal', function onModalHide() {
                resetModalState();
                modalElement.removeEventListener('hidden.bs.modal', onModalHide);
            }, { once: true });
            
            modal.show();
            
            // Populate order items in read-only mode
            renderOrderItemsInViewMode(order.items || []);
            
        } catch (error) {
            console.error('Error viewing order:', error);
            showAlert(error.message || 'Failed to load order details', 'danger');
        }
    }
    
    function renderOrderItemsInViewMode(items) {
        const itemsList = document.getElementById('orderItemsList');
        
        if (items.length === 0) {
            itemsList.innerHTML = '<div class="text-muted text-center py-3">No items in this order</div>';
            document.getElementById('orderTotal').textContent = '0.00';
            return;
        }

        itemsList.innerHTML = items.map(item => `
            <div class="order-item card mb-2">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${item.productName || 'Unknown Product'}</h6>
                            <div class="text-muted">
                                <div>Price: $${item.unitPrice ? item.unitPrice.toFixed(2) : '0.00'} each</div>
                                <div>Quantity: ${item.quantity || 0}</div>
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold">$${item.lineTotal ? item.lineTotal.toFixed(2) : '0.00'}</div>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        
        // Calculate and display total
        const total = items.reduce((sum, item) => {
            return sum + (item.lineTotal || 0);
        }, 0);
        document.getElementById('orderTotal').textContent = total.toFixed(2);
    }
    
    let availableProducts = [];
    let currentOrderItems = [];

    async function fetchAvailableProducts() {
        try {
            const response = await fetch('/api/v1/products?size=1000');
            if (!response.ok) throw new Error('Failed to fetch products');
            const data = await response.json();
            availableProducts = data.content || [];
        } catch (error) {
            console.error('Error fetching products:', error);
            showAlert('Failed to load available products', 'danger');
        }
    }

    function renderOrderItems(items) {
        const itemsList = document.getElementById('orderItemsList');
        currentOrderItems = []; // Clear current items before updating
        
        if (!items || items.length === 0) {
            itemsList.innerHTML = '<div class="text-muted text-center py-3">No items in this order</div>';
            updateOrderTotal();
            return;
        }

        // Process items to ensure all required fields are present
        const processedItems = items.map(item => {
            // Ensure we have a valid item
            if (!item) return null;
            
            // Find the product in availableProducts to get current stock
            const product = availableProducts.find(p => p && (p.id === item.productId || p.id === item.id));
            
            // Get stock from item or product, with better handling of missing data
            let availableStock = 0;
            
            // First try to get from the item itself
            if (item.availableStock !== undefined && item.availableStock !== null) {
                availableStock = parseInt(item.availableStock) || 0;
            } 
            // Then try to get from the product
            else if (product) {
                if (product.quantity !== undefined && product.quantity !== null) {
                    availableStock = parseInt(product.quantity) || 0;
                } else if (product.stock !== undefined && product.stock !== null) {
                    availableStock = parseInt(product.stock) || 0;
                }
            }
            
            // If we still don't have stock, try to get it from the original item data
            if (availableStock === 0 && item.originalStock !== undefined) {
                availableStock = parseInt(item.originalStock) || 0;
            }
            
            // Ensure we have valid values
            const quantity = Math.max(1, parseInt(item.quantity) || 1);
            const unitPrice = parseFloat(item.unitPrice || item.price || 0);
            const productName = item.productName || (product ? product.name : 'Unknown Product');
            const productId = item.productId || item.id;
            
            console.log(`Processing item: ${productId} - ${productName}`, {
                item: item,
                product: product,
                availableStock: availableStock,
                unitPrice: unitPrice,
                quantity: quantity,
                allAvailableProducts: availableProducts
            });
            
            return {
                ...item,
                id: item.id,
                productId: productId,
                productName: productName,
                unitPrice: unitPrice,
                quantity: quantity,
                availableStock: availableStock,
                lineTotal: unitPrice * quantity
            };
        }).filter(item => item !== null); // Remove any null items
        
        console.log('Rendering order items:', processedItems); // Debug log
        
        currentOrderItems = [...processedItems];
        
        itemsList.innerHTML = processedItems.map((item, index) => {
            const stockInfo = item.availableStock !== undefined ? 
                item.availableStock : 
                (availableProducts.find(p => p && p.id === item.productId)?.stock ?? 'N/A');
                
            const isOutOfStock = stockInfo === 0 || stockInfo === '0' || stockInfo === 0;
            const isAtMaxQuantity = stockInfo !== 'N/A' && item.quantity >= stockInfo;
            
            console.log(`Item ${item.productId} - Stock: ${stockInfo}, Qty: ${item.quantity}, Out of Stock: ${isOutOfStock}`); // Debug log
            
            return `
            <div class="order-item card mb-2" data-index="${index}">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${item.productName}</h6>
                            <small class="text-muted">$${item.unitPrice.toFixed(2)} each</small>
                            <div class="d-flex align-items-center mt-1">
                                <button class="btn btn-sm btn-outline-secondary btn-quantity" 
                                    data-action="decrease" 
                                    data-index="${index}"
                                    ${item.quantity <= 1 ? 'disabled' : ''}>
                                    <i class="bi bi-dash"></i>
                                </button>
                                <input type="number" 
                                    class="form-control form-control-sm mx-1 quantity-input" 
                                    value="${item.quantity}" 
                                    min="1" 
                                    max="${stockInfo !== 'N/A' ? stockInfo : ''}"
                                    style="width: 60px; text-align: center;"
                                    data-index="${index}"
                                    ${isOutOfStock ? 'readonly' : ''}>
                                <button class="btn btn-sm btn-outline-secondary btn-quantity" 
                                    data-action="increase" 
                                    data-index="${index}"
                                    ${isOutOfStock || isAtMaxQuantity ? 'disabled' : ''}>
                                    <i class="bi bi-plus"></i>
                                </button>
                                <small class="ms-2 ${isOutOfStock ? 'text-danger' : ''}">
                                    Available: ${stockInfo}
                                </small>
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold">$${(item.unitPrice * item.quantity).toFixed(2)}</div>
                            <button class="btn btn-sm btn-outline-danger btn-remove-item" 
                                data-index="${index}"
                                ${items.length <= 1 ? 'disabled' : ''}>
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>`;
        }).join('');

        updateOrderTotal();
        
        // Add event listeners for quantity changes
        document.querySelectorAll('.btn-quantity').forEach(btn => {
            btn.addEventListener('click', handleQuantityChange);
        });
        
        // Add event listeners for quantity inputs
        document.querySelectorAll('.quantity-input').forEach(input => {
            input.addEventListener('change', handleQuantityInput);
        });
        
        // Add event listeners for remove buttons
        document.querySelectorAll('.btn-remove-item').forEach(btn => {
            btn.addEventListener('click', handleRemoveItem);
        });
    }

    function updateOrderTotal() {
        const total = currentOrderItems.reduce((sum, item) => {
            return sum + (item.unitPrice * item.quantity);
        }, 0);
        document.getElementById('orderTotal').textContent = total.toFixed(2);
    }

    function handleQuantityChange(e) {
        // Prevent event from bubbling up to parent elements
        e.preventDefault();
        e.stopPropagation();
        
        const action = e.currentTarget.getAttribute('data-action');
        const index = parseInt(e.currentTarget.getAttribute('data-index'));
        const item = currentOrderItems[index];
        
        if (action === 'increase') {
            // Check stock availability
            if (item.availableStock !== undefined && item.quantity >= item.availableStock) {
                showAlert(`Only ${item.availableStock} items available in stock for ${item.productName}`, 'warning');
                return;
            }
            item.quantity = (item.quantity || 0) + 1;
        } else if (action === 'decrease' && item.quantity > 1) {
            item.quantity--;
        }
        
        // Update the input field
        const input = document.querySelector(`.quantity-input[data-index="${index}"]`);
        if (input) input.value = item.quantity;
        
        updateOrderTotal();
    }

    function handleQuantityInput(e) {
        const index = parseInt(e.target.getAttribute('data-index'));
        const newQuantity = parseInt(e.target.value);
        const item = currentOrderItems[index];
        
        if (isNaN(newQuantity) || newQuantity < 1) {
            e.target.value = 1;
            item.quantity = 1;
        } else if (item.availableStock !== undefined && newQuantity > item.availableStock) {
            e.target.value = item.availableStock;
            item.quantity = item.availableStock;
            showAlert(`Only ${item.availableStock} items available in stock`, 'warning');
        } else {
            item.quantity = newQuantity;
        }
        
        updateOrderTotal();
    }

    function handleRemoveItem(e) {
        const index = parseInt(e.currentTarget.getAttribute('data-index'));
        currentOrderItems.splice(index, 1);
        renderOrderItems(currentOrderItems);
    }

    async function showAddItemModal() {
        if (availableProducts.length === 0) {
            await fetchAvailableProducts();
        }
        
        // Filter out products already in the order
        const orderProductIds = currentOrderItems.map(item => item.productId);
        const availableProductsList = availableProducts.filter(
            product => !orderProductIds.includes(product.id)
        );
        
        if (availableProductsList.length === 0) {
            showAlert('All available products are already in this order', 'info');
            return;
        }
        
        // Create and show the add item modal
        const modalContent = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Product</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Select Product</label>
                            <select class="form-select" id="selectProduct">
                                ${availableProductsList.map(p => 
                                    `<option value="${p.id}">${p.name} ($${p.price.toFixed(2)}, Stock: ${p.stock || 'N/A'})</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="itemQuantity" value="1" min="1">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="confirmAddItem">Add to Order</button>
                    </div>
                </div>
            </div>
        `;
        
        const modalEl = document.createElement('div');
        modalEl.className = 'modal fade';
        modalEl.id = 'addItemModal';
        modalEl.innerHTML = modalContent;
        document.body.appendChild(modalEl);
        
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
        
        // Handle add item confirmation
        document.getElementById('confirmAddItem').addEventListener('click', () => {
            const productId = parseInt(document.getElementById('selectProduct').value);
            const quantity = parseInt(document.getElementById('itemQuantity').value);
            const product = availableProducts.find(p => p.id === productId);
            
            if (product) {
                currentOrderItems.push({
                    productId: product.id,
                    productName: product.name,
                    unitPrice: product.price,
                    quantity: quantity,
                    availableStock: product.stock
                });
                renderOrderItems(currentOrderItems);
            }
            
            // Clean up and remove the modal
            modal.hide();
            document.body.removeChild(modalEl);
        });
        
        // Clean up when modal is closed
        modalEl.addEventListener('hidden.bs.modal', () => {
            document.body.removeChild(modalEl);
        });
    }

    function resetModalState() {
        // Reset modal title
        document.getElementById('editOrderModalLabel').textContent = 'Edit Order';
        
        // Show save button
        document.getElementById('saveOrderChanges').style.display = 'block';
        
        // Remove read-only from form controls
        const formControls = document.querySelectorAll('#editOrderForm input, #editOrderForm select, #editOrderForm textarea');
        formControls.forEach(control => {
            control.removeAttribute('readonly');
            control.classList.remove('bg-light');
        });
        
        // Show action buttons in order items
        document.querySelectorAll('.btn-quantity, .btn-remove-item, #addItemBtn').forEach(btn => {
            if (btn) btn.style.display = '';
        });
        
        // Re-enable status dropdown
        const statusSelect = document.getElementById('editStatus');
        if (statusSelect) statusSelect.disabled = false;
    }
    
    async function editOrder(orderId) {
        try {
            // Reset modal state in case it was in view mode
            resetModalState();
            
            currentEditingOrderId = orderId;
            const [orderResponse, productsResponse] = await Promise.all([
                fetch(`${API_URL}/${orderId}`),
                fetch('/api/v1/products?size=1000')
            ]);
            
            if (!orderResponse.ok) throw new Error('Failed to fetch order details');
            if (!productsResponse.ok) throw new Error('Failed to fetch product details');
            
            const order = await orderResponse.json();
            const productsData = await productsResponse.json();
            availableProducts = productsData.content || [];
            
            console.log('Available products:', availableProducts); // Debug log
            
            // First, get all product IDs from the order
            const productIds = [...new Set(order.items.map(item => item.productId))];
            console.log('Fetching products with IDs:', productIds);
            
            // Fetch all products in a single request for stock information
            let productsMap = new Map();
            
            try {
                // First try to fetch all products at once
                const productsUrl = `/api/v1/products?ids=${productIds.join(',')}`;
                console.log('Fetching products from:', productsUrl);
                const stockProductsResponse = await fetch(productsUrl);
                if (stockProductsResponse.ok) {
                    const response = await stockProductsResponse.json();
                    console.log('Raw products API response:', response);
                    const productsList = response.content || response.products || [response].filter(Boolean);
                    
                    productsList.forEach(product => {
                        if (product && product.id) {
                            // Get stock from either quantity or stock field
                            const stock = product.quantity !== undefined ? product.quantity : 
                                       (product.stock !== undefined ? product.stock : 0);
                            
                            productsMap.set(product.id, {
                                ...product,
                                stock: stock,
                                quantity: stock  // For backward compatibility
                            });
                        }
                    });
                    console.log('Fetched products for stock:', productsMap);
                } else {
                    console.warn('Bulk fetch failed, trying individual requests');
                    // If bulk fetch fails, try individual requests
                    await Promise.all(productIds.map(async (id) => {
                        try {
                            const response = await fetch(`/api/v1/products/${id}`);
                            if (response.ok) {
                                const product = await response.json();
                                if (product && product.id) {
                                    const stock = product.quantity !== undefined ? product.quantity : 
                                                (product.stock !== undefined ? product.stock : 0);
                                    productsMap.set(product.id, {
                                        ...product,
                                        stock: stock,
                                        quantity: stock
                                    });
                                }
                            }
                        } catch (e) {
                            console.error(`Error fetching product ${id}:`, e);
                        }
                    }));
                }
            } catch (e) {
                console.error('Error fetching product data:', e);
            }
            
            // Enrich order items with product data and stock information
            const enrichedItems = (order.items || []).map(item => {
                const product = productsMap.get(item.productId) || availableProducts.find(p => p.id === item.productId);
                const availableStock = product ? (product.stock || 0) : 0;
                const productName = product ? (product.name || item.productName) : item.productName;
                
                console.log(`Item ${item.productId} - Stock: ${availableStock}, Name: ${productName}`);
                
                return {
                    ...item,
                    productId: item.productId,
                    productName: productName,
                    unitPrice: parseFloat(item.unitPrice || 0),
                    quantity: parseInt(item.quantity || 1),
                    availableStock: availableStock,
                    lineTotal: item.lineTotal || (parseFloat(item.unitPrice || 0) * parseInt(item.quantity || 1))
                };
            });
            
            console.log('Enriched order items:', enrichedItems);
            
            console.log('Enriched items:', enrichedItems); // Debug log
            
            const modalElement = document.getElementById('editOrderModal');
            if (!modalElement) {
                throw new Error('Edit order modal not found');
            }
            
            // Set modal title
            const modalTitle = modalElement.querySelector('.modal-title');
            if (modalTitle) {
                modalTitle.textContent = `Edit Order #${order.id || ''}`;
            }
            
            // Show save button
            const saveButton = document.getElementById('saveOrderChanges');
            if (saveButton) {
                saveButton.style.display = 'block';
            }
            
            // Helper function to safely set values
            const setValueIfExists = (id, value) => {
                const element = document.getElementById(id);
                if (element) element.value = value || '';
            };
            
            // Populate the modal with order data
            const orderIdElement = document.getElementById('editOrderId');
            if (orderIdElement) orderIdElement.textContent = order.id || '';
            
            setValueIfExists('editCustomerName', order.customerName);
            setValueIfExists('editPhoneNumber', order.phoneNumber);
            setValueIfExists('editAddress', order.address);
            setValueIfExists('editPaymentMethod', order.paymentMethod);
            setValueIfExists('editStatus', order.status);
            setValueIfExists('editNotes', order.notes);
            
            // Enable the status dropdown
            const statusSelect = document.getElementById('editStatus');
            if (statusSelect) statusSelect.disabled = false;
            
            // Show the modal
            const modal = new bootstrap.Modal(modalElement);
            
            // Reset modal state when hidden
            modalElement.addEventListener('hidden.bs.modal', function onModalHide() {
                resetModalState();
                modalElement.removeEventListener('hidden.bs.modal', onModalHide);
            }, { once: true });
            
            // Populate order items
            renderOrderItems(enrichedItems);
            
            // Show the modal after a small delay to ensure everything is rendered
            setTimeout(() => {
                modal.show();
            }, 50);
            
        } catch (error) {
            console.error('Error loading order details:', error);
            showAlert(error.message || 'Failed to load order details', 'danger');
        }
    }
    

    function confirmDelete(orderId) {
        if (confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
            deleteOrder(orderId);
        }
    }

    async function deleteOrder(orderId) {
        try {
            const response = await fetch(`/api/v1/orders/${orderId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                showAlert('Order deleted successfully', 'success');
                loadOrders(currentPage); // Reload current page
            } else {
                const error = await response.json();
                throw new Error(error.message || 'Failed to delete order');
            }
        } catch (error) {
            console.error('Error deleting order:', error);
            showAlert(error.message || 'Failed to delete order', 'danger');
        }
    }

    async function updateStatus(orderId, newStatus) {
        try {
            const response = await fetch(`/api/v1/orders/${orderId}/status?status=${encodeURIComponent(newStatus)}`, {
                method: 'PUT'
            });
            
            if (response.ok) {
                showAlert(`Order status updated to ${newStatus}`, 'success');
                loadOrders(currentPage); // Reload current page
            } else {
                const error = await response.json();
                throw new Error(error.message || 'Failed to update status');
            }
        } catch (error) {
            console.error('Error updating status:', error);
            showAlert(error.message || 'Failed to update status', 'danger');
        }
    }

    function showAlert(message, type = 'info') {
        // Convert newlines to <br> for better formatting
        const formattedMessage = message.replace(/\n/g, '<br>');
        
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert" style="white-space: pre-line;">
                ${formattedMessage}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        
        // Create a container for alerts if it doesn't exist
        let alertContainer = document.getElementById('alertContainer');
        if (!alertContainer) {
            alertContainer = document.createElement('div');
            alertContainer.id = 'alertContainer';
            alertContainer.style.position = 'fixed';
            alertContainer.style.top = '20px';
            alertContainer.style.right = '20px';
            alertContainer.style.zIndex = '1100';
            alertContainer.style.maxWidth = '400px';
            document.body.appendChild(alertContainer);
        }
        
        // Create and append the alert
        const alertElement = document.createElement('div');
        alertElement.innerHTML = alertHtml;
        alertContainer.appendChild(alertElement);
        
        // Auto-remove the alert after 5 seconds
        setTimeout(() => {
            if (alertElement) {
                const bsAlert = new bootstrap.Alert(alertElement.querySelector('.alert'));
                bsAlert.close();
                setTimeout(() => {
                    if (alertElement.parentNode) {
                        alertElement.remove();
                    }
                }, 150);
            }
        }, 5000);
    }
</script>

<!-- Add Bootstrap JS and Popper.js for dropdowns and tooltips -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
