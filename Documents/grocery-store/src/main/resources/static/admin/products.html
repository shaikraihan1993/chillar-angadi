<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Products - Grocery Store Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="icon" type="image/png" href="/images/logo.png">
    <style>
        .sidebar {
            min-height: calc(100vh - 56px);
            background-color: #f8f9fa;
            padding: 20px 0;
        }
        .nav-link {
            color: #333;
            padding: 10px 20px;
            margin: 5px 10px;
            border-radius: 5px;
        }
        .nav-link:hover, .nav-link.active {
            background-color: #e9ecef;
            color: #0d6efd;
        }
        .main-content {
            padding: 20px;
        }
        .product-img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 10px;
        }
        .status-in-stock {
            background-color: #198754;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .status-out-of-stock {
            background-color: #dc3545;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .action-buttons {
            display: flex;
            gap: 0.25rem;
            flex-wrap: nowrap;
        }
        .action-buttons .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            line-height: 1.2;
        }
    </style>
</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-dark bg-success">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">Grocery Store Admin</a>
        <div>
            <a href="/store.html" class="btn btn-outline-light me-2">
                <i class="bi bi-shop"></i> Back to Store
            </a>
        </div>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 d-md-block sidebar collapse">
            <div class="d-flex flex-column flex-shrink-0 p-3">
                <ul class="nav nav-pills flex-column mb-auto">
                    <li class="nav-item">
                        <a href="/admin/index.html" class="nav-link">
                            <i class="bi bi-speedometer2 me-2"></i>
                            Dashboard
                        </a>
                    </li>
                    <li>
                        <a href="/admin/products.html" class="nav-link active">
                            <i class="bi bi-box-seam me-2"></i>
                            Products
                        </a>
                    </li>
                    <li>
                        <a href="/admin/orders.html" class="nav-link">
                            <i class="bi bi-cart3 me-2"></i>
                            Orders
                        </a>
                    </li>
                    <li>
                        <a href="/admin/users.html" class="nav-link">
                            <i class="bi bi-people me-2"></i>
                            Users
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Main content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>Product Management</h2>
                    <p class="text-muted mb-0">Manage your product inventory and details.</p>
                </div>
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#productModal">
                    <i class="bi bi-plus-circle"></i> Add Product
                </button>
            </div>

            <div class="card p-4 mb-4">
                <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
                    <h4 class="mb-0">Product List</h4>
                    <div class="search-container" style="display: flex; gap: 10px; align-items: center;">
                        <input
                                type="text"
                                id="searchInput"
                                class="form-control"
                                placeholder="Search products..."
                                style="width: 250px;"
                        />
                        <button class="btn btn-outline-secondary" onclick="loadProducts(0)">
                            <i class="bi bi-search"></i> Search
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearSearch()">
                            <i class="bi bi-x-lg"></i> Clear
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th>Image</th>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Subcategory</th>
                            <th>Brand</th>
                            <th>Price</th>
                            <th>Stock</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody id="productsTableBody">
                        <!-- Products will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <nav>
                    <ul class="pagination mt-3" id="pagination"></ul>
                </nav>
            </div>
        </main>
    </div>
</div>

<!-- Add/Edit Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add New Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="productForm">
                <div class="modal-body">
                    <input type="hidden" id="productId" name="id">
                    <!-- Image Upload -->
                    <div class="mb-3">
                        <label for="productImage" class="form-label">Product Image</label>
                        <input class="form-control" type="file" id="productImage" accept="image/*">
                        <div class="form-text">Select an image for the product (JPEG, PNG, etc.)</div>
                    </div>
                    <div class="mb-3" id="imagePreviewContainer" style="display: none;">
                        <img id="imagePreview" src="#" alt="Preview" class="img-thumbnail" style="max-height: 200px;">
                    </div>
                    <div class="mb-3">
                        <label for="name" class="form-label">Product Name</label>
                        <input type="text" class="form-control" id="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" rows="2"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="brand" class="form-label">Brand</label>
                            <input type="text" class="form-control" id="brand" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="manufacturer" class="form-label">Manufacturer</label>
                            <input type="text" class="form-control" id="manufacturer">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="category" class="form-label">Category</label>
                            <select class="form-select" id="category" required onchange="updateSubcategories()">
                                <option value="">Select Category</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="subCategory" class="form-label">Subcategory</label>
                            <select class="form-select" id="subCategory" required>
                                <option value="">Select Subcategory</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="quantity" class="form-label">Quantity</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="quantity" min="0" required>
                                <select class="form-select" id="unit" style="max-width: 100px;">
                                    <option value="">Unit</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="price" class="form-label">Price</label>
                            <input type="number" class="form-control" id="price" step="0.01" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="stock" class="form-label">Stock</label>
                            <input type="number" class="form-control" id="stock" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Product</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this product? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

<script>
    // Global variables
    const API_URL = '/api/v1/products';
    const itemsPerPage = 10;
    let currentPage = 0;
    let currentImageFile = null;
    let currentImageId = null;
    let searchQuery = '';
    let currentProductId = null;
    let ProductUnit = {}; // Will be populated from the server
    let ProductCategory = {}; // Will be populated from the server
    let ProductSubCategory = {}; // Will be populated from the server
    let totalPages = 0;

    // Function to update subcategories based on selected category
    function updateSubcategories() {
        const categorySelect = document.getElementById('category');
        const subCategorySelect = document.getElementById('subCategory');
        const selectedCategory = categorySelect ? categorySelect.value : '';

        if (!subCategorySelect) return;

        // Clear existing options
        subCategorySelect.innerHTML = '<option value="">Select Subcategory</option>';

        if (!selectedCategory || !ProductSubCategory) return;

        // Filter and add subcategories for the selected category
        try {
            Object.entries(ProductSubCategory)
                .filter(([_, subCat]) => subCat && subCat.category === selectedCategory)
                .forEach(([key, subCat]) => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = subCat.displayName || key;
                    subCategorySelect.appendChild(option);
                });
        } catch (error) {
            console.error('Error updating subcategories:', error);
        }
    }

    // Function to populate unit dropdown
    function populateUnitDropdown() {
        const unitSelect = document.getElementById('unit');
        if (!unitSelect) return;

        unitSelect.innerHTML = '<option value="">Unit</option>';

        if (Object.keys(ProductUnit).length === 0) {
            console.warn('ProductUnit enum is empty');
            return;
        }

        Object.entries(ProductUnit).forEach(([key, value]) => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = value.displayName || key;
            unitSelect.appendChild(option);
        });
    }

    // Function to populate the category dropdown
    function populateCategories(categories) {
        const categorySelect = document.getElementById('category');
        if (!categorySelect) return;

        categorySelect.innerHTML = '<option value="">Select Category</option>';

        // If categories is an object, convert it to an array of {key, value} pairs
        const categoriesArray = Array.isArray(categories)
            ? categories
            : Object.entries(categories || {}).map(([key, value]) => ({
                key,
                ...(typeof value === 'object' ? value : { displayName: value })
            }));

        categoriesArray.forEach(item => {
            const option = document.createElement('option');
            option.value = item.key || item.name || item;
            option.textContent = item.displayName || item.name || item;
            categorySelect.appendChild(option);
        });
    }

    // Function to load enums from the server
    async function loadEnums() {
        try {
            // Load ProductCategory enum
            const categoryResponse = await fetch('/api/v1/enums/product-categories');
            if (categoryResponse.ok) {
                const categories = await categoryResponse.json();
                ProductCategory = categories; // Store the raw categories
                populateCategories(categories);
            } else {
                console.error('Failed to load categories:', await categoryResponse.text());
            }

            // Load ProductSubCategory enum
            const subCategoryResponse = await fetch('/api/v1/enums/product-subcategories');
            if (subCategoryResponse.ok) {
                ProductSubCategory = await subCategoryResponse.json();
            } else {
                console.error('Failed to load subcategories:', await subCategoryResponse.text());
            }

            // Load ProductUnit enum
            const unitResponse = await fetch('/api/v1/enums/product-units');
            if (unitResponse.ok) {
                ProductUnit = await unitResponse.json();
                populateUnitDropdown();
            } else {
                console.error('Failed to load units:', await unitResponse.text());
            }

            // Initialize the form
            updateSubcategories();

        } catch (error) {
            console.error('Error loading enums:', error);
            showAlert('Failed to load form data. Please refresh the page.', 'danger');
        }
    }

    // Function to load products
    async function loadProducts(page) {
        try {
            let url = `${API_URL}?page=${page}&size=${itemsPerPage}`;
            if (searchQuery) {
                url += `&name=${encodeURIComponent(searchQuery)}`;
            }

            const response = await fetch(url, {
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Error response:', errorText);
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            // Handle the response format from the backend
            const products = data.products || data.content || [];
            const totalPages = data.totalPages || 0;

            renderProducts(products);
            renderPagination(totalPages);
            currentPage = page;
        } catch (error) {
            console.error('Error loading products:', error);
            showAlert('Failed to load products. Please try again.', 'danger');
        }
    }

    function renderProducts(products) {
        const tbody = document.getElementById("productsTableBody");
        if (!tbody) {
            console.error('Products table body not found!');
            return;
        }

        tbody.innerHTML = "";

        if (!products || products.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center text-muted">No products found.</td>
                </tr>`;
            return;
        }

        products.forEach((product, index) => {
            // Safely access properties with fallbacks
            const name = product.name || 'N/A';
            const category = typeof product.category === 'object' ?
                           (product.category.displayName || product.category.name || 'N/A') :
                           (product.category || 'N/A');
            const subCategory = typeof product.subCategory === 'object' ?
                              (product.subCategory.displayName || product.subCategory.name || 'N/A') :
                              (product.subCategory || 'N/A');
            const brand = product.brand || 'N/A';
            const price = product.price ? `$${parseFloat(product.price).toFixed(2)}` : '$0.00';
            const quantity = product.quantity || 0;
            const unit = product.unit || '';
            const stock = quantity + ' ' + (unit.displayName || unit.symbol || unit || '');

            // Handle image URL
            let imageUrl = 'https://via.placeholder.com/50';
            if (product.imageId) {
                imageUrl = `/api/v1/images/${product.imageId}`;
            } else if (product.imageUrl) {
                imageUrl = product.imageUrl;
            } else if (product.images && product.images.length > 0) {
                // If there's an array of images, use the first one
                imageUrl = product.images[0].url || imageUrl;
            }

            const statusClass = quantity > 0 ? 'status-in-stock' : 'status-out-of-stock';
            const statusText = quantity > 0 ? 'In Stock' : 'Out of Stock';

            const row = `
                <tr>
                    <td>
                        <img src="${imageUrl}"
                             alt="${name}"
                             class="product-img"
                             onerror="this.onerror=null; this.src='https://via.placeholder.com/50';">
                    </td>
                    <td>${name}</td>
                    <td>${category}</td>
                    <td>${subCategory}</td>
                    <td>${brand}</td>
                    <td>${price}</td>
                    <td>${stock}</td>
                    <td><span class="${statusClass}">${statusText}</span></td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-outline-primary edit-btn" data-id="${product.id}" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${product.id}" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>`;

                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

    function renderPagination(pages) {
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";
        totalPages = pages;

        // Previous button
        pagination.innerHTML += `
            <li class="page-item ${currentPage === 0 ? 'disabled' : ''}">
                <button class="page-link" ${currentPage === 0 ? '' : `onclick="loadProducts(${currentPage - 1})"`}>
                    &laquo;
                </button>
            </li>`;

        // Page numbers
        const maxVisiblePages = 5;
        let startPage = Math.max(0, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(pages - 1, startPage + maxVisiblePages - 1);

        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(0, endPage - maxVisiblePages + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            pagination.innerHTML += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <button class="page-link" onclick="loadProducts(${i})">
                        ${i + 1}
                    </button>
                </li>`;
        }

        // Next button
        pagination.innerHTML += `
            <li class="page-item ${currentPage >= totalPages - 1 ? 'disabled' : ''}">
                <button class="page-link" ${currentPage >= totalPages - 1 ? '' : `onclick="loadProducts(${currentPage + 1})"`}>
                    &raquo;
                </button>
            </li>`;
    }

    function clearSearch() {
        const searchInput = document.getElementById('searchInput');
        searchInput.value = '';
        searchQuery = '';
        loadProducts(0);
    }

    // Event listener for search input enter key
    document.getElementById('searchInput')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchQuery = this.value.trim();
            loadProducts(0);
        }
    });

    // Function to load product data into the form for editing
    function editProduct(productId) {
    if (!productId) {
        resetProductForm();
        document.getElementById('modalTitle').textContent = 'Add New Product';
        document.getElementById('imagePreviewContainer').style.display = 'none';
        const modal = new bootstrap.Modal(document.getElementById('productModal'));
        modal.show();
        return;
    }

    // Fetch the product details
    fetch(`${API_URL}/${productId}`)
        .then(response => response.json())
        .then(product => {
            // Reset the form first
            resetProductForm();

            // Populate the form with product data
            document.getElementById('productId').value = product.id || '';
            document.getElementById('name').value = product.name || '';
            document.getElementById('description').value = product.description || '';
            document.getElementById('price').value = product.price || '';
            // Use quantity instead of stock to match the backend model
            document.getElementById('stock').value = product.quantity || '';
            // Remove category field as it's not in the backend model
            if (document.getElementById('category')) {
                document.getElementById('category').value = '';
            }

            // Handle image preview if image exists
            const previewContainer = document.getElementById('imagePreviewContainer');
            const imagePreview = document.getElementById('imagePreview');
            if (product.imageUrl && imagePreview) {
                try {
                    // Extract image ID from the URL
                    const imageId = product.imageUrl.split('/').pop();
                    currentImageId = imageId;
                    imagePreview.src = product.imageUrl;
                    if (previewContainer) {
                        previewContainer.style.display = 'block';
                    }
                } catch (e) {
                    console.error('Error setting image preview:', e);
                    if (previewContainer) {
                        previewContainer.style.display = 'none';
                    }
                }
            } else if (previewContainer) {
                previewContainer.style.display = 'none';
            }

            document.getElementById('modalTitle').textContent = 'Edit Product';
            const modal = new bootstrap.Modal(document.getElementById('productModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error loading product:', error);
            showAlert('Failed to load product details. Please try again.', 'danger');
        });
}

    // Function to reset the product form
    function resetProductForm() {
        document.getElementById('productForm').reset();
        document.getElementById('productId').value = '';
        document.getElementById('modalTitle').textContent = 'Add New Product';
    }

    document.getElementById('confirmDelete').addEventListener('click', function() {
        if (!currentProductId) return;

        fetch(`/api/v1/products/${currentProductId}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (response.ok) {
                loadProducts(currentPage);
                document.getElementById('deleteModal').querySelector('.btn-close').click();
                showAlert('Product deleted successfully!', 'success');
            }
        })
        .catch(error => {
            console.error('Error deleting product:', error);
            showAlert('Error deleting product. Please try again.', 'danger');
        });
    });

    // Show alert
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
        alertDiv.role = 'alert';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.body.appendChild(alertDiv);

        // Auto-remove alert after 3 seconds
        setTimeout(() => {
            const alert = bootstrap.Alert.getOrCreateInstance(alertDiv);
            alert.close();
        }, 3000);
    }

    // Handle click events on edit and delete buttons using event delegation
    document.addEventListener('click', function(event) {
        // Handle edit button click
        if (event.target.closest('.edit-btn')) {
            const button = event.target.closest('.edit-btn');
            const productId = button.dataset.id;
            editProduct(productId);
        }

        // Handle delete button click
        if (event.target.closest('.delete-btn')) {
            const button = event.target.closest('.delete-btn');
            currentProductId = button.dataset.id;

            // Show the delete confirmation modal
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            deleteModal.show();
        }
    });

    // Form validation function
    function validateForm() {
        const name = document.getElementById('name').value.trim();
        const price = parseFloat(document.getElementById('price').value);
        const stock = parseInt(document.getElementById('stock').value, 10);
        const brand = document.getElementById('brand').value.trim();
        
        if (!name) {
            showAlert('Product name is required', 'danger');
            return false;
        }
        if (!brand) {
            showAlert('Brand is required', 'danger');
            return false;
        }
        if (isNaN(price) || price <= 0) {
            showAlert('Please enter a valid price', 'danger');
            return false;
        }
        if (isNaN(stock) || stock < 0) {
            showAlert('Please enter a valid stock quantity', 'danger');
            return false;
        }
        return true;
    }

    // Handle form submission
    const productForm = document.getElementById('productForm');
    if (productForm) {
        productForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!validateForm()) {
                return;
            }

            const productId = document.getElementById('productId').value;
            const isUpdate = !!productId;
            const submitButton = this.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;

        try {
            // Disable the submit button and show loading state
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';

            // Clear any previous alerts
            const alertDiv = document.querySelector('.alert');
            if (alertDiv) {
                alertDiv.remove();
            }

            // First upload the image if a new one was selected
            let imageUrl = null;
            if (currentImageFile) {
                try {
                    const formData = new FormData();
                    formData.append('file', currentImageFile);

                    // If updating, include the product ID
                    if (isUpdate) {
                        formData.append('productId', productId);
                    }

                    const uploadResponse = await fetch('/api/v1/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (!uploadResponse.ok) {
                        const error = await uploadResponse.json();
                        throw new Error(error.error || 'Failed to upload image');
                    }

                    const result = await uploadResponse.json();
                    console.log('Upload response:', result);
                    
                    // Handle the upload response format: {"id":"96","url":"/api/v1/images/96"}
                    if (result.id) {
                        // Convert the ID to a number since the backend expects a Long
                        currentImageId = Number(result.id);
                        console.log('Set currentImageId from upload response:', currentImageId, 'Type:', typeof currentImageId);
                    }
                    
                    // Set imageUrl if available
                    if (result.url) {
                        imageUrl = result.url;
                        console.log('Set imageUrl from upload response:', imageUrl);
                    }
                } catch (error) {
                    console.error('Image upload error:', error);
                    throw new Error('Failed to upload image. Please try again.');
                }
            }

            // Prepare product data with proper type conversion and null checks
            const productData = {
                name: document.getElementById('name').value.trim(),
                description: document.getElementById('description').value.trim() || null,
                brand: document.getElementById('brand').value.trim(),
                price: parseFloat(document.getElementById('price').value) || 0,
                quantity: parseInt(document.getElementById('stock').value, 10) || 0
            };

            // Only add category if it has a value
            const categoryValue = document.getElementById('category').value;
            if (categoryValue) {
                productData.category = categoryValue;
            }

            // Only add subCategory if it has a value
            const subCategoryValue = document.getElementById('subCategory').value;
            if (subCategoryValue) {
                productData.subCategory = subCategoryValue;
            }

            // Only add unit if it has a value
            const unitValue = document.getElementById('unit').value;
            if (unitValue) {
                productData.unit = unitValue;
            }

            // Debug: Log all available image information
            console.log('Current image state - currentImageId:', currentImageId, 'imageUrl:', imageUrl);
            
            // Always include imageId if we have it
            if (currentImageId) {
                console.log('Including imageId in product data:', currentImageId);
                productData.imageId = currentImageId;
                // Don't include imageUrl to avoid any confusion
                delete productData.imageUrl;
            } else if (imageUrl) {
                console.log('No imageId available, using imageUrl:', imageUrl);
                productData.imageUrl = imageUrl;
                delete productData.imageId;
            } else {
                console.log('No image data available for product');
                delete productData.imageUrl;
                delete productData.imageId;
            }
            
            // Log the final product data for debugging
            console.log('Product data being sent:', JSON.stringify(productData, null, 2));

            // Save the product
            const url = isUpdate ? `${API_URL}/${productId}` : API_URL;
            const method = isUpdate ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(productData)
            });

            if (response.status === 401) {
                // Handle unauthorized (e.g., session expired)
                window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
                return;
            }

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Failed to save product');
            }

            // Close the modal, show success message, and reload the page
            const modalElement = document.getElementById('productModal');
            if (modalElement) {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) modal.hide();
            }

            // Show success message
            showAlert(`Product ${isUpdate ? 'updated' : 'created'} successfully!`, 'success');

            // Reload the products list
            await loadProducts(currentPage);

            // Reset the form and image preview
            if (productForm) {
                productForm.reset();
            }
            currentImageFile = null;
            currentImageId = null;
            const previewContainer = document.getElementById('imagePreviewContainer');
            const fileInput = document.getElementById('productImage');
            if (previewContainer) {
                previewContainer.style.display = 'none';
            }
            if (fileInput) {
                fileInput.value = ''; // Reset file input
            }

            // Scroll to top of the page
            window.scrollTo({ top: 0, behavior: 'smooth' });

                } catch (error) {
            console.error('Error:', error);
            showAlert(error.message || 'An error occurred. Please try again.', 'danger');

            // Log the error to an error tracking service if available
            if (window.trackJs) {
                window.trackJs.track(error);
            }
            } finally {
                // Re-enable the submit button
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = isUpdate ? 'Update Product' : 'Add Product';
                }
            }
        });
    }

    // Handle file input change
    document.getElementById('productImage')?.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            currentImageFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                const imagePreview = document.getElementById('imagePreview');
                const previewContainer = document.getElementById('imagePreviewContainer');
                if (imagePreview) {
                    imagePreview.src = e.target.result;
                }
                if (previewContainer) {
                    previewContainer.style.display = 'block';
                }
            };
            reader.readAsDataURL(file);
        } else {
            currentImageFile = null;
            const previewContainer = document.getElementById('imagePreviewContainer');
            if (previewContainer) {
                previewContainer.style.display = 'none';
            }
        }
    });

    // Initialize the page when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM fully loaded, initializing...');

        // Create an async IIFE to handle async operations
        (async function() {
            try {
                // First load enums
                console.log('Loading enums...');
                await loadEnums();
                // Load products after enums
                await loadProducts(0);

                // Initialize tooltips
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.forEach(tooltipTriggerEl => {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });

                // Reset form when modal is closed
                const productModal = document.getElementById('productModal');
                if (productModal) {
                    productModal.addEventListener('hidden.bs.modal', function () {
                        resetProductForm();
                    });
                }

                // Initialize modals
                const modals = [
                    { id: 'deleteModal', event: 'shown.bs.modal' },
                    { id: 'productModal', event: 'hidden.bs.modal' }
                ];

                modals.forEach(modal => {
                    const element = document.getElementById(modal.id);
                    if (element) {
                        element.addEventListener(modal.event, function() {
                            // Focus the close button when modal is shown
                            const closeButton = element.querySelector('.btn-secondary');
                            if (closeButton) closeButton.focus();
                        });
                    }
                });

                // Add click handler for the "Add Product" button
                const addProductBtn = document.querySelector('button[data-bs-target="#productModal"]');
                if (addProductBtn) {
                    addProductBtn.addEventListener('click', function() {
                        editProduct(); // Call without ID to create new product
                    });
                }

                console.log('Page initialization complete');

            } catch (error) {
                console.error('Error during initialization:', error);
                showAlert('Failed to initialize the page. Please check the console for details.', 'danger');
            }
        })(); // End of async IIFE
    }); // End of DOMContentLoaded
</script>
</body>
</html>
