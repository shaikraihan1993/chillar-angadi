<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Products - Grocery Store Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <style>
        .sidebar {
            min-height: calc(100vh - 56px);
            background-color: #f8f9fa;
            padding: 20px 0;
        }
        .nav-link {
            color: #333;
            padding: 10px 20px;
            margin: 5px 10px;
            border-radius: 5px;
        }
        .nav-link:hover, .nav-link.active {
            background-color: #e9ecef;
            color: #0d6efd;
        }
        .main-content {
            padding: 20px;
        }
        .product-img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">Grocery Store Admin</a>
            <div>
                <a href="/store.html" class="btn btn-outline-light me-2">
                    <i class="bi bi-shop"></i> Back to Store
                </a>
                <a href="/admin/" class="btn btn-outline-light">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="d-flex flex-column flex-shrink-0 p-3">
                    <ul class="nav nav-pills flex-column mb-auto">
                        <li class="nav-item">
                            <a href="/admin/index.html" class="nav-link">
                                <i class="bi bi-speedometer2 me-2"></i>
                                Dashboard
                            </a>
                        </li>
                        <li>
                            <a href="/admin/products.html" class="nav-link active">
                                <i class="bi bi-box-seam me-2"></i>
                                Products
                            </a>
                        </li>
                        <li>
                            <a href="/admin/orders.html" class="nav-link">
                                <i class="bi bi-cart3 me-2"></i>
                                Orders
                            </a>
                        </li>
                        <li>
                            <a href="/admin/users.html" class="nav-link">
                                <i class="bi bi-people me-2"></i>
                                Users
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Manage Products</h1>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                        <i class="bi bi-plus-circle"></i> Add Product
                    </button>
                </div>

                <!-- Products Table -->
                <div class="card">
                    <div class="card-body">
                        <table id="productsTable" class="table table-striped" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <!-- Products will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Add New Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="productForm">
                    <div class="modal-body">
                        <input type="hidden" id="productId">
                        <div class="mb-3">
                            <label for="name" class="form-label">Product Name</label>
                            <input type="text" class="form-control" id="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="price" class="form-label">Price</label>
                                <input type="number" class="form-control" id="price" step="0.01" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="stock" class="form-label">Stock</label>
                                <input type="number" class="form-control" id="stock" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="category" class="form-label">Category</label>
                            <select class="form-select" id="category" required>
                                <option value="">Select Category</option>
                                <option value="Fruits">Fruits</option>
                                <option value="Vegetables">Vegetables</option>
                                <option value="Dairy">Dairy</option>
                                <option value="Bakery">Bakery</option>
                                <option value="Meat">Meat</option>
                                <option value="Beverages">Beverages</option>
                                <option value="Snacks">Snacks</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="imageUrl" class="form-label">Image URL</label>
                            <input type="text" class="form-control" id="imageUrl" placeholder="https://example.com/image.jpg">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Product</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this product? This action cannot be undone.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    
    <script>
        let currentProductId = null;
        const productsTable = $('#productsTable').DataTable({
            responsive: true,
            order: [[1, 'asc']],
            columns: [
                { data: 'image', orderable: false },
                { data: 'name' },
                { data: 'category' },
                { data: 'price' },
                { data: 'stock' },
                { data: 'actions', orderable: false }
            ]
        });

        // Load products
        function loadProducts() {
            fetch('/api/v1/products')
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw err; });
                    }
                    return response.json();
                })
                .then(data => {
                    productsTable.clear().draw();
                    if (data && data.products) {
                        data.products.forEach(product => {
                            productsTable.row.add({
                                'image': `<img src="${product.imageUrl || 'https://via.placeholder.com/50'}" 
                                        alt="${product.name}" class="product-img">`,
                                'name': product.name,
                                'category': product.category || 'Uncategorized',
                                'price': `$${parseFloat(product.price || 0).toFixed(2)}`,
                                'stock': product.stock || 0,
                                'actions': `
                                    <button class="btn btn-sm btn-warning edit-btn" data-id="${product.id}">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger delete-btn" data-id="${product.id}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                `
                            }).draw(false);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading products:', error);
                    showAlert(error.error || 'Failed to load products', 'danger');
                });
        }

        // Reset form
        function resetForm() {
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('modalTitle').textContent = 'Add New Product';
        }

        // Show add product modal
        document.querySelector('[data-bs-target="#productModal"]').addEventListener('click', () => {
            resetForm();
            const modal = new bootstrap.Modal(document.getElementById('productModal'));
            modal.show();
        });

        // Handle form submission
        document.getElementById('productForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const product = {
                name: document.getElementById('name').value,
                description: document.getElementById('description').value,
                price: parseFloat(document.getElementById('price').value),
                stock: parseInt(document.getElementById('stock').value),
                category: document.getElementById('category').value,
                imageUrl: document.getElementById('imageUrl').value || null
            };

            const productId = document.getElementById('productId').value;
            const method = productId ? 'PUT' : 'POST';
            const url = productId ? `/api/v1/products/${productId}` : '/api/v1/products';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(product)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(data => {
                loadProducts();
                const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
                if (modal) modal.hide();
                showAlert('Product saved successfully!', 'success');
            })
            .catch(error => {
                console.error('Error saving product:', error);
                showAlert(error.error || 'Error saving product. Please try again.', 'danger');
            });
        });

        // Edit product
        $(document).on('click', '.edit-btn', function() {
            const productId = $(this).data('id');
            fetch(`/api/v1/products/${productId}`)
                .then(response => response.json())
                .then(product => {
                    document.getElementById('productId').value = product.id;
                    document.getElementById('name').value = product.name;
                    document.getElementById('description').value = product.description || '';
                    document.getElementById('price').value = product.price;
                    document.getElementById('stock').value = product.stock;
                    document.getElementById('category').value = product.category || '';
                    document.getElementById('imageUrl').value = product.imageUrl || '';
                    document.getElementById('modalTitle').textContent = 'Edit Product';
                    
                    const modal = new bootstrap.Modal(document.getElementById('productModal'));
                    modal.show();
                });
        });

        // Delete product
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        
        $(document).on('click', '.delete-btn', function() {
            currentProductId = $(this).data('id');
            deleteModal.show();
        });

        document.getElementById('confirmDelete').addEventListener('click', function() {
            if (!currentProductId) return;
            
            fetch(`/api/v1/products/${currentProductId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    loadProducts();
                    deleteModal.hide();
                    showAlert('Product deleted successfully!', 'success');
                }
            })
            .catch(error => {
                console.error('Error deleting product:', error);
                showAlert('Error deleting product. Please try again.', 'danger');
            });
        });

        // Show alert
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.body.appendChild(alertDiv);
            
            // Auto-remove alert after 3 seconds
            setTimeout(() => {
                const alert = bootstrap.Alert.getOrCreateInstance(alertDiv);
                alert.close();
            }, 3000);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();
        });
    </script>
</body>
</html>
